name: ðŸ—‘ï¸ Destroy Azure Infrastructure

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to destroy'
        required: true
        type: choice
        options:
          - dev
          - staging
          - production
      confirmation:
        description: 'Type "DESTROY" to confirm deletion'
        required: true
        type: string
      delete_backend:
        description: 'Also delete Terraform backend storage?'
        required: true
        type: boolean
        default: false

permissions:
  contents: read
  id-token: write

env:
  TERRAFORM_VERSION: '1.9.0'
  BACKEND_RG: tf-backend-rg
  TF_VAR_PROJECT_NAME: 'devops-portfolio'
  TF_VAR_LOCATION: 'eastus'

jobs:

# =======================================================
# Job 1: Validate Destroy Request
# =======================================================
  validate-destroy:
    name: âœ… Validate Destroy Request
    runs-on: ubuntu-latest

    steps:
      - name: Validate confirmation
        run: |
          if [ "${{ github.event.inputs.confirmation }}" != "DESTROY" ]; then
            echo "âŒ Confirmation must be DESTROY"
            exit 1
          fi
          echo "âœ… Confirmation validated"

      - name: Show destruction plan
        run: |
          echo "# âš ï¸ INFRASTRUCTURE DESTRUCTION PLAN" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Delete backend**: ${{ github.event.inputs.delete_backend }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp**: $(date -u)" >> $GITHUB_STEP_SUMMARY

# =======================================================
# Job 2: Manual Approval
# =======================================================
  approval:
    name: ðŸ›‘ Manual Approval Required
    runs-on: ubuntu-latest
    needs: validate-destroy
    environment:
      name: destroy-approval

    steps:
      - run: |
          echo "âœ… Manual approval granted"

# =======================================================
# Job 3: Backup Terraform State
# =======================================================
  backup-state:
    name: ðŸ’¾ Backup Terraform State
    runs-on: ubuntu-latest
    needs: approval

    steps:
      - uses: actions/checkout@v4

      - uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Find backend storage
        id: backend
        run: |
          BACKEND=$(az storage account list \
            --resource-group ${{ env.BACKEND_RG }} \
            --query "[0].name" -o tsv 2>/dev/null || echo "")
          
          if [ -z "$BACKEND" ]; then
            echo "backend_exists=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "backend_exists=true" >> $GITHUB_OUTPUT
          echo "backend_name=$BACKEND" >> $GITHUB_OUTPUT

      - name: Backup tfstate
        if: steps.backend.outputs.backend_exists == 'true'
        run: |
          BACKUP_FILE="tfstate-backup-$(date +%Y%m%d-%H%M%S).tfstate"

          az storage blob download \
            --account-name ${{ steps.backend.outputs.backend_name }} \
            --container-name tfstate \
            --name infra.tfstate \
            --file "$BACKUP_FILE" \
            --auth-mode login || true

          az storage container create \
            --account-name ${{ steps.backend.outputs.backend_name }} \
            --name tfstate-backups \
            --auth-mode login || true

          az storage blob upload \
            --account-name ${{ steps.backend.outputs.backend_name }} \
            --container-name tfstate-backups \
            --name "$BACKUP_FILE" \
            --file "$BACKUP_FILE" \
            --auth-mode login || true

# =======================================================
# Job 4: Cleanup Kubernetes (Helm-first)
# =======================================================
  cleanup-kubernetes:
    name: ðŸ§¹ Cleanup Kubernetes Resources
    runs-on: ubuntu-latest
    needs: approval
    continue-on-error: true

    steps:
      - uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Get AKS credentials
        run: |
          AKS_NAME="devops-portfolio-${{ github.event.inputs.environment }}-aks"
          RG_NAME="devops-portfolio-${{ github.event.inputs.environment }}-rg"

          az aks get-credentials \
            --name "$AKS_NAME" \
            --resource-group "$RG_NAME" \
            --overwrite-existing || exit 0

      - uses: azure/setup-helm@v4

      - name: Helm uninstall
        run: |
          helm uninstall portfolio-prod -n production || true
          kubectl delete namespace production || true

# =======================================================
# Job 5: Terraform Destroy
# =======================================================
  terraform-destroy:
    name: ðŸ’¥ Terraform Destroy
    runs-on: ubuntu-latest
    needs: [approval, backup-state, cleanup-kubernetes]

    steps:
      - uses: actions/checkout@v4

      - uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: Locate Terraform directory
        run: |
          if [ -d "terraform" ]; then
            echo "TF_DIR=terraform" >> $GITHUB_ENV
          else
            echo "âŒ Terraform directory not found"
            exit 1
          fi

      - name: Terraform Init
        run: |
          cd $TF_DIR
          terraform init \
            -backend-config="resource_group_name=${{ env.BACKEND_RG }}" \
            -backend-config="container_name=tfstate" \
            -backend-config="key=infra.tfstate" \
            -backend-config="use_azuread_auth=true"

      - name: Terraform Destroy
        run: |
          cd $TF_DIR
          terraform destroy -auto-approve \
            -var="project_name=${{ env.TF_VAR_PROJECT_NAME }}" \
            -var="environment=${{ github.event.inputs.environment }}" \
            -var="location=${{ env.TF_VAR_LOCATION }}"

# =======================================================
# Job 6: Optional Backend Cleanup
# =======================================================
  cleanup-backend:
    name: ðŸ§¹ Cleanup Terraform Backend
    runs-on: ubuntu-latest
    needs: terraform-destroy
    if: github.event.inputs.delete_backend == 'true'

    steps:
      - uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Delete backend RG
        run: |
          az group delete \
            --name ${{ env.BACKEND_RG }} \
            --yes --no-wait

# =======================================================
# Job 7: Final Summary
# =======================================================
  summary:
    name: ðŸ“Š Destroy Summary
    runs-on: ubuntu-latest
    needs: [validate-destroy, approval, backup-state, cleanup-kubernetes, terraform-destroy, cleanup-backend]
    if: always()

    steps:
      - run: |
          echo "# ðŸ—‘ï¸ Destroy Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by**: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend deleted**: ${{ github.event.inputs.delete_backend }}" >> $GITHUB_STEP_SUMMARY
